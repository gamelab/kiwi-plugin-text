Kiwi.Plugins.Text=function(a){this._maxHeight=a.maxHeight||1/0,this._maxLines=a.maxLines||1/0,this._maxWidth=a.maxWidth||1/0,this._tempDirty=!0,"string"!=typeof a.text&&("number"==typeof a.text?a.text=""+a.text:a.text="text"),isNaN(a.x)&&(a.x=0),isNaN(a.y)&&(a.y=0),void 0===a.color&&(a.color="#000000"),void 0===a.size&&(a.size=32),void 0===a.fontSize&&(a.fontSize=a.size),void 0===a.weight&&(a.weight="normal"),void 0===a.fontFamily&&(a.fontFamily="sans-serif"),Kiwi.Entity.call(this,a.state,a.x,a.y),this.rotation=isNaN(a.rotation)?0:a.rotation,this.scale=isNaN(a.scale)?1:a.scale,this.scaleX=isNaN(a.scaleX)?this.scaleX:a.scaleX,this.scaleY=isNaN(a.scaleY)?this.scaleY:a.scaleY,this.alpha=isNaN(a.alpha)?1:a.alpha,this.anchorPointX=isNaN(a.anchorPointX)?0:a.anchorPointX,this.anchorPointY=isNaN(a.anchorPointY)?0:a.anchorPointY,this._anchorNormalX=a.anchorNormalX,this._anchorNormalY=a.anchorNormalY,this.game.renderOption===Kiwi.RENDERER_WEBGL&&(this.glRenderer=this.game.renderer.requestSharedRenderer("TextureAtlasRenderer")),this.lineHeight=a.lineHeight||"1em",a.lineHeightNormalized&&(this.lineHeightNormalized=a.lineHeightNormalized),this._text=a.text,this._fontWeight=a.weight,this._fontSize=a.fontSize,this._fontColor=new Kiwi.Utils.Color(a.color),this._fontFamily=a.fontFamily,this._textAlign="left",a.alignment&&(this.alignment=a.alignment),this._baseline="top",this._canvas=document.createElement("canvas"),this._canvas.width=2,this._canvas.height=2,this._ctx=this._canvas.getContext("2d"),this.atlas=new Kiwi.Textures.SingleImage(this.game.rnd.uuid(),this._canvas),this.state.textureLibrary.add(this.atlas),this.atlas.dirty=!0,this.box=this.components.add(new Kiwi.Components.Box(this,this.x,this.y,this.width,this.height)),a.addToState!==!1&&this.state.addChild(this),this._createPool()},Kiwi.extend(Kiwi.Plugins.Text,Kiwi.Entity),Kiwi.Plugins.Text.prototype.create=function(a){},Kiwi.Plugins.Text.prototype._createPool=function(){this._pool={pt1:new Kiwi.Geom.Point(0,0),pt2:new Kiwi.Geom.Point(0,0),pt3:new Kiwi.Geom.Point(0,0),pt4:new Kiwi.Geom.Point(0,0),xOffset:0}},Kiwi.Plugins.Text.name="Text",Kiwi.Plugins.Text.version="0.0.1",Kiwi.Plugins.Text.prototype.objType=function(){return"Text"},Object.defineProperty(Kiwi.Plugins.Text.prototype,"anchorNormalX",{get:function(){return this._anchorNormalX},set:function(a){this._anchorNormalX=a,this.anchorPointX=this.width*this._anchorNormalX}}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"anchorNormalY",{get:function(){return this._anchorNormalY},set:function(a){this._anchorNormalY=a,this.anchorPointY=this.height*this._anchorNormalY}}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"alignment",{get:function(){return this._textAlign},set:function(a){this._textAlign=a,this._tempDirty=!0}}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(a){this._lineHeight=a,this._tempDirty=!0}}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"lineHeightNormalized",{get:function(){var a=1;return"em"===this._lineHeight.slice(-2)?a=this._lineHeight.slice(0,this._lineHeight.length-2):"px"===this._lineHeight.slice(-2)&&(a=this._lineHeight.slice(0,this._lineHeight.length-2)/this._fontSize),isNaN(a)&&(a=1),1*a},set:function(a){isNaN(a)||(this._lineHeight=a+"em")}}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"text",{get:function(){return this._text},set:function(a){this._text=a,this._tempDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"color",{get:function(){return"#"+this._fontColor.getHex()},set:function(a){Kiwi.Utils.Common.isArray(a)||(a=[a]),this._fontColor.set.apply(this._fontColor,a),this._tempDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"fontWeight",{get:function(){return this._fontWeight},set:function(a){this._fontWeight=a,this._tempDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"fontSize",{get:function(){return this._fontSize},set:function(a){this._fontSize=a,this._tempDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"size",{get:function(){return this._fontSize},set:function(a){this._fontSize=a,this._tempDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"fontFamily",{get:function(){return this._fontFamily},set:function(a){this._fontFamily=a,this._tempDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"maxHeight",{get:function(){return this._maxHeight},set:function(a){this._maxHeight=a?a:1/0,this._tempDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"maxLines",{get:function(){return this._maxLines},set:function(a){this._maxLines=a?a:1/0,this._tempDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"maxWidth",{get:function(){return this._maxWidth},set:function(a){this._maxWidth=a?a:1/0,this._tempDirty=!0},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.Text.prototype,"textAlign",{get:function(){return this._textAlign},set:function(a){this._textAlign=a,this._tempDirty=!0},enumerable:!0,configurable:!0}),Kiwi.Plugins.Text.prototype.renderText=function(){var a,b,c,d,e,f,g,h,i;for(this._ctx.font=this._fontWeight+" "+this._fontSize+"px "+this._fontFamily,f=this.text,f=f.replace(/ *$\s/gm," \n "),f=f.split(" "),e=[],c=0;f.length>0;){for(d=[];this._ctx.measureText(d.join(" ")).width<=this._maxWidth&&f.length>0;){if("\n"===f[0]){f.shift();break}d.push(f.shift())}if(this._ctx.measureText(d.join(" ")).width>this._maxWidth)if(d.length>1)f.unshift(d.pop());else{for(f.unshift(d.pop()),h="";this._ctx.measureText(h+"-").width<=this._maxWidth&&f[0].length>1;)h+=f[0].slice(0,1),f[0]=f[0].slice(1);this._ctx.measureText(h+"-").width>this._maxWidth&&h.length>1&&(f[0]=h.slice(-1)+f[0],h=h.slice(0,h.length-1)),h+="-",d.push(h)}if(e.push(d.join(" ")),c=Math.max(c,this._ctx.measureText(d.join(" ")).width),e.length===this._maxLines||this._fontSize*this.lineHeightNormalized*(e.length+1.5)>this._maxHeight)break}if(g=c,a=this._fontSize*this.lineHeightNormalized*(e.length+.5),this.width=g,this.height=a,this._anchorNormalX&&(this.anchorPointX=this._anchorNormalX*g),this._anchorNormalY&&(this.anchorPointY=this._anchorNormalY*a),-1===Kiwi.Utils.Common.base2Sizes.indexOf(g)||4096===g){for(b=0;Kiwi.Utils.Common.base2Sizes[b]<2048&&g>Kiwi.Utils.Common.base2Sizes[b];)b++;g=Kiwi.Utils.Common.base2Sizes[b]}if(-1===Kiwi.Utils.Common.base2Sizes.indexOf(a)||4096===a){for(b=0;Kiwi.Utils.Common.base2Sizes[b]<2048&&a>Kiwi.Utils.Common.base2Sizes[b];)b++;a=Kiwi.Utils.Common.base2Sizes[b]}this._canvas.width=g,this._canvas.height=a,this._ctx.clearRect(0,0,g,a),this._ctx.font=this._fontWeight+" "+this._fontSize+"px "+this._fontFamily,this._ctx.fillStyle=this.color.slice(0,7),this._ctx.textBaseline=this._baseline;for(b in e){switch(i=0,this._textAlign){case Kiwi.Plugins.Text.TEXT_ALIGN_CENTER:i=(this.width-this._ctx.measureText(e[b]).width)/2;break;case Kiwi.Plugins.Text.TEXT_ALIGN_RIGHT:i=this.width-this._ctx.measureText(e[b]).width}this._ctx.fillText(e[b],i,b*this._fontSize*this.lineHeightNormalized)}this.atlas.cells[0]={x:0,y:0,w:this._canvas.width,h:this._canvas.height,hitboxes:[{x:this._textAlign===Kiwi.Plugins.Text.TEXT_ALIGN_LEFT?0:this._textAlign===Kiwi.Plugins.Text.TEXT_ALIGN_CENTER?.5*-this.width:-this.width,y:0,w:this.width,h:this.height}]},this._tempDirty=!1,this.atlas.dirty=!0},Kiwi.Plugins.Text.prototype.render=function(a){var b;if(this.alpha>0&&this.visible){switch(this.game.stage.ctx.save(),this.alpha>0&&this.alpha<=1&&(this.game.stage.ctx.globalAlpha=this.alpha),this._tempDirty&&this.renderText(),this._textAlign){case Kiwi.Plugins.Text.TEXT_ALIGN_LEFT:this._pool.xOffset=0;break;case Kiwi.Plugins.Text.TEXT_ALIGN_CENTER:this._pool.xOffset=.5*this.width;break;case Kiwi.Plugins.Text.TEXT_ALIGN_RIGHT:this._pool.xOffset=this.width}b=this.transform.getConcatenatedMatrix(),this.game.stage.ctx.transform(b.a,b.b,b.c,b.d,b.tx,b.ty),this.game.stage.ctx.drawImage(this._canvas,0,0,this._canvas.width,this._canvas.height,-this.transform.anchorPointX-this._pool.xOffset,-this.transform.anchorPointY,this._canvas.width,this._canvas.height),this.game.stage.ctx.restore()}},Kiwi.Plugins.Text.prototype.renderGL=function(a,b,c){this._tempDirty&&this.renderText();var d=this.transform.getConcatenatedMatrix();switch(this._textAlign){case Kiwi.Plugins.Text.TEXT_ALIGN_LEFT:this._pool.xOffset=0;break;case Kiwi.Plugins.Text.TEXT_ALIGN_CENTER:this._pool.xOffset=-(.5*this.width);break;case Kiwi.Plugins.Text.TEXT_ALIGN_RIGHT:this._pool.xOffset=-this.width}this._pool.pt1.setTo(this._pool.xOffset-this.transform.anchorPointX,0-this.transform.anchorPointY),this._pool.pt2.setTo(this._canvas.width+this._pool.xOffset-this.transform.anchorPointX,0-this.transform.anchorPointY),this._pool.pt3.setTo(this._canvas.width+this._pool.xOffset-this.transform.anchorPointX,this._canvas.height-this.transform.anchorPointY),this._pool.pt4.setTo(this._pool.xOffset-this.transform.anchorPointX,this._canvas.height-this.transform.anchorPointY),d.transformPoint(this._pool.pt1),d.transformPoint(this._pool.pt2),d.transformPoint(this._pool.pt3),d.transformPoint(this._pool.pt4),this.glRenderer.concatBatch([this._pool.pt1.x,this._pool.pt1.y,0,0,this.alpha,this._pool.pt2.x,this._pool.pt2.y,this._canvas.width,0,this.alpha,this._pool.pt3.x,this._pool.pt3.y,this._canvas.width,this._canvas.height,this.alpha,this._pool.pt4.x,this._pool.pt4.y,0,this._canvas.height,this.alpha])},Kiwi.Plugins.Text.TEXT_ALIGN_CENTER="center",Kiwi.Plugins.Text.TEXT_ALIGN_RIGHT="right",Kiwi.Plugins.Text.TEXT_ALIGN_LEFT="left";